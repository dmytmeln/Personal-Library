<div class="search-container">
  <h1 class="page-title">Пошук</h1>

  <mat-tab-group [(selectedIndex)]="uiState.activeTabIndex" (selectedIndexChange)="onTabChange($event)"
                 mat-stretch-tabs="false" mat-align-tabs="start" animationDuration="0ms">

    <mat-tab label="Книги">
      <div class="tab-content">
        <div class="filters-section">
          <div class="filter-row">
            <mat-form-field appearance="outline" class="filter-field" subscriptSizing="dynamic">
              <mat-label>Назва книги</mat-label>
              <input
                matInput
                [(ngModel)]="filterState.title"
                (ngModelChange)="onTitleInput()"
                placeholder="Пошук за назвою...">
              @if (filterState.title) {
                <button mat-icon-button matSuffix (click)="clearTitleFilter()">
                  <mat-icon>close</mat-icon>
                </button>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="filter-field" subscriptSizing="dynamic">
              <mat-label>Автор</mat-label>
              <input
                matInput
                [(ngModel)]="filterState.author.searchInput"
                (ngModelChange)="onAuthorSearchInput()"
                (focus)="onAuthorSearchInput()"
                [matAutocomplete]="authorAuto"
                placeholder="Пошук автора...">
              @if (filterState.author.selected) {
                <button mat-icon-button matSuffix (click)="clearAuthorFilter()">
                  <mat-icon>close</mat-icon>
                </button>
              }
              <mat-autocomplete #authorAuto="matAutocomplete" (optionSelected)="onAuthorSelected($event.option.value)">
                @for (author of filterState.author.filtered; track author.id) {
                  <mat-option [value]="author">{{ author.fullName }}</mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>

            <mat-form-field appearance="outline" class="filter-field" subscriptSizing="dynamic">
              <mat-label>Категорія</mat-label>
              <input
                matInput
                [(ngModel)]="filterState.category.searchInput"
                (ngModelChange)="onCategorySearchInput()"
                (focus)="onCategorySearchInput()"
                [matAutocomplete]="categoryAuto"
                placeholder="Пошук категорії...">
              @if (filterState.category.selected) {
                <button mat-icon-button matSuffix (click)="clearCategoryFilter()">
                  <mat-icon>close</mat-icon>
                </button>
              }
              <mat-autocomplete #categoryAuto="matAutocomplete"
                                (optionSelected)="onCategorySelected($event.option.value)">
                @for (category of filterState.category.filtered; track category.id) {
                  <mat-option [value]="category">{{ category.name }}</mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>
          </div>

          <div class="filter-row">
            <div class="range-filter">
              <span class="range-label">Рік видання:</span>
              <mat-form-field appearance="outline" class="range-input"
                              subscriptSizing="dynamic">
                <mat-label>Від</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="filterState.publishYearMin"
                  (ngModelChange)="onPublishYearMinChange()"
                  placeholder="1900">
              </mat-form-field>
              <mat-form-field appearance="outline" class="range-input"
                              subscriptSizing="dynamic">
                <mat-label>До</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="filterState.publishYearMax"
                  (ngModelChange)="onPublishYearMaxChange()"
                  placeholder="2026">
              </mat-form-field>
              <button mat-icon-button
                      (click)="clearPublishYearFilters()"
                      matTooltip="Скинути фільтр року"
                      [style.visibility]="filterState.publishYearMin !== null || filterState.publishYearMax !== null ? 'visible' : 'hidden'">
                <mat-icon>close</mat-icon>
              </button>
            </div>

            <div class="range-filter">
              <span class="range-label">Кількість сторінок:</span>
              <mat-form-field appearance="outline" class="range-input" subscriptSizing="dynamic">
                <mat-label>Від</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="filterState.pagesMin"
                  (ngModelChange)="onPagesMinChange()"
                  placeholder="0">
              </mat-form-field>
              <mat-form-field appearance="outline" class="range-input" subscriptSizing="dynamic">
                <mat-label>До</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="filterState.pagesMax"
                  (ngModelChange)="onPagesMaxChange()"
                  placeholder="5000">
              </mat-form-field>
              <button mat-icon-button
                      (click)="clearPagesFilters()"
                      matTooltip="Скинути фільтр сторінок"
                      [style.visibility]="filterState.pagesMin !== null || filterState.pagesMax !== null ? 'visible' : 'hidden'">
                <mat-icon>close</mat-icon>
              </button>
            </div>

            @if (hasActiveFilters()) {
              <button mat-stroked-button (click)="clearAllFilters()" class="clear-filters-btn"
                      matTooltip="Скинути всі фільтри">
                <mat-icon>filter_alt_off</mat-icon>
                Скинути всі
              </button>
            }
          </div>

          <div class="language-filter" *ngIf="languagesState.available.length > 0">
            <div class="language-filter-header">
              <span class="range-label">Мови:</span>
              @if (hasSelectedLanguage()) {
                <button mat-stroked-button (click)="clearLanguageFilters()" class="language-action-btn">
                  Очистити
                </button>
              }
            </div>
            <div class="language-checkboxes">
              @for (lang of displayedLanguages; track lang.language) {
                <mat-checkbox
                  [checked]="isLanguageSelected(lang.language)"
                  (change)="toggleLanguage(lang.language)"
                  class="language-checkbox">
                  {{ lang.language }} <span class="language-count">({{ lang.count }})</span>
                </mat-checkbox>
              }
            </div>
            @if (hasMoreLanguages) {
              <button mat-stroked-button (click)="toggleShowAllLanguages()" class="show-more-btn">
                {{ languagesState.showAll ? 'Показати менше' : 'Показати більше' }}
              </button>
            }
          </div>
        </div>

        <app-books-grid
          [books]="booksState.items"
          [totalElements]="booksState.pagination.totalElements"
          [pageSize]="booksState.pagination.pageSize"
          [pageIndex]="booksState.pagination.currentPage"
          [loading]="booksState.loading"
          [actionsMenu]="addBookAction"
          (pageChange)="onBooksPageChange($event)"
          (sortChange)="onBooksSortChange($event)"/>
      </div>
    </mat-tab>

    <mat-tab label="Автори">
      <div class="tab-content">
        <div class="filters-section">
          <div class="filter-row">
            <mat-form-field appearance="outline" class="filter-field" subscriptSizing="dynamic">
              <mat-label>Пошук за ім'ям</mat-label>
              <input
                matInput
                [(ngModel)]="authorsState.search.name"
                (ngModelChange)="onAuthorNameSearch()"
                placeholder="Введіть ім'я автора...">
              @if (authorsState.search.name) {
                <button mat-icon-button matSuffix (click)="clearAuthorNameSearch()">
                  <mat-icon>close</mat-icon>
                </button>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="filter-field" subscriptSizing="dynamic">
              <mat-label>Країна</mat-label>
              <mat-select
                [(ngModel)]="authorsState.filter.country"
                (selectionChange)="onAuthorCountrySelected($event.value)">
                <mat-option [value]="null">Всі країни</mat-option>
                @for (country of authorsState.countries; track country.country) {
                  <mat-option [value]="country.country">{{ country.country }} ({{ country.count }})</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <div class="range-filter">
              <span class="range-label">Рік народження:</span>
              <mat-form-field appearance="outline" class="range-input" subscriptSizing="dynamic">
                <mat-label>Від</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="authorsState.filter.birthYearMin"
                  (ngModelChange)="onAuthorBirthYearMinChange()"
                  placeholder="1800">
              </mat-form-field>
              <mat-form-field appearance="outline" class="range-input" subscriptSizing="dynamic">
                <mat-label>До</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="authorsState.filter.birthYearMax"
                  (ngModelChange)="onAuthorBirthYearMaxChange()"
                  placeholder="2020">
              </mat-form-field>
              <button mat-icon-button
                      (click)="clearAuthorBirthYearFilters()"
                      matTooltip="Скинути фільтр року"
                      [style.visibility]="authorsState.filter.birthYearMin !== null || authorsState.filter.birthYearMax !== null ? 'visible' : 'hidden'">
                <mat-icon>close</mat-icon>
              </button>
            </div>

            <div class="range-filter">
              <span class="range-label">Книг:</span>
              <mat-form-field appearance="outline" class="range-input" subscriptSizing="dynamic">
                <mat-label>Від</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="authorsState.filter.booksCountMin"
                  (ngModelChange)="onAuthorBooksCountMinChange()"
                  placeholder="0">
              </mat-form-field>
              <mat-form-field appearance="outline" class="range-input" subscriptSizing="dynamic">
                <mat-label>До</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="authorsState.filter.booksCountMax"
                  (ngModelChange)="onAuthorBooksCountMaxChange()"
                  placeholder="100">
              </mat-form-field>
              <button mat-icon-button
                      (click)="clearAuthorBooksCountFilters()"
                      matTooltip="Скинути фільтр книг"
                      [style.visibility]="authorsState.filter.booksCountMin !== null || authorsState.filter.booksCountMax !== null ? 'visible' : 'hidden'">
                <mat-icon>close</mat-icon>
              </button>
            </div>

            @if (hasAuthorFilters() || authorsState.search.name) {
              <button mat-stroked-button (click)="clearAllAuthorFilters()" class="clear-filters-btn"
                      matTooltip="Скинути всі фільтри">
                <mat-icon>filter_alt_off</mat-icon>
                Скинути всі
              </button>
            }
          </div>
        </div>

        <div class="sort-section">
          <span class="sort-label">Сортувати за:</span>
          <div class="sort-options">
            @for (option of authorsState.sorting.options; track option.field) {
              <div
                class="sort-option"
                [class.active]="isAuthorSorted(option)"
                (click)="onAuthorSortClick(option)"
                matTooltip="Натисніть для сортування">
                <span class="sort-option-label">{{ option.label }}</span>
                <div class="sort-arrows">
                  @if (getAuthorSortDirection(option) === 'asc') {
                    <mat-icon class="sort-arrow active">arrow_upward</mat-icon>
                  } @else if (getAuthorSortDirection(option) === 'desc') {
                    <mat-icon class="sort-arrow active">arrow_downward</mat-icon>
                  } @else {
                    <mat-icon class="sort-arrow">arrow_upward</mat-icon>
                  }
                </div>
                @if (isAuthorSorted(option)) {
                  <span class="sort-priority">{{ getAuthorSortPriority(option) }}</span>
                }
              </div>
            }
            @if (hasAuthorSorts()) {
              <button mat-stroked-button (click)="clearAuthorSorts()" class="clear-sort-btn"
                      matTooltip="Скинути сортування">
                <mat-icon>clear_all</mat-icon>
                Скинути
              </button>
            }
          </div>
        </div>

        <div class="content-wrapper">
          @if (authorsState.loading) {
            <div class="loading-overlay">
              <mat-spinner diameter="50"></mat-spinner>
            </div>
          }
          <div class="authors-table-container">
            <table class="authors-table">
              <thead>
              <tr>
                <th>ПІБ</th>
                <th>Країна</th>
                <th>Рік народження</th>
                <th>Рік смерті</th>
                <th>Кількість книг</th>
                <th>Дії</th>
              </tr>
              </thead>
              <tbody>
                @for (author of authorsState.items; track author.id) {
                  <tr>
                    <td>
                      <a class="author-link" (click)="goToAuthorDetails(author)">{{ author.fullName }}</a>
                    </td>
                    <td>{{ author.country }}</td>
                    <td>{{ author.birthYear }}</td>
                    <td>{{ author.deathYear || '-' }}</td>
                    <td>{{ getBooksCountText(author.booksCount || 0) }}</td>
                    <td>
                      <div class="action-buttons">
                        <button mat-stroked-button (click)="goToAuthorDetails(author)" class="action-btn">
                          Деталі
                        </button>
                        <button mat-stroked-button (click)="showAuthorBooks(author)" class="action-btn">
                          Книги
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <mat-paginator
            [length]="authorsState.pagination.totalElements"
            [pageSize]="authorsState.pagination.pageSize"
            [pageIndex]="authorsState.pagination.currentPage"
            [pageSizeOptions]="[12, 24, 48]"
            (page)="onAuthorPageChange($event)"
            aria-label="Вибрати сторінку">
          </mat-paginator>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Категорії">
      <div class="tab-content">
        <div class="filters-section">
          <div class="filter-row">
            <mat-form-field appearance="outline" class="filter-field" subscriptSizing="dynamic">
              <mat-label>Пошук за назвою</mat-label>
              <input
                matInput
                [(ngModel)]="categoriesState.search.name"
                (ngModelChange)="onCategoryNameSearch()"
                placeholder="Введіть назву категорії...">
              @if (categoriesState.search.name) {
                <button mat-icon-button matSuffix (click)="clearCategoryNameSearch()">
                  <mat-icon>close</mat-icon>
                </button>
              }
            </mat-form-field>

            <div class="range-filter">
              <span class="range-label">Книг:</span>
              <mat-form-field appearance="outline" class="range-input" subscriptSizing="dynamic">
                <mat-label>Від</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="categoriesState.filter.booksCountMin"
                  (ngModelChange)="onCategoryBooksCountMinChange()"
                  placeholder="0">
              </mat-form-field>
              <mat-form-field appearance="outline" class="range-input" subscriptSizing="dynamic">
                <mat-label>До</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="categoriesState.filter.booksCountMax"
                  (ngModelChange)="onCategoryBooksCountMaxChange()"
                  placeholder="100">
              </mat-form-field>
              <button mat-icon-button
                      (click)="clearCategoryBooksCountFilters()"
                      matTooltip="Скинути фільтр"
                      [style.visibility]="categoriesState.filter.booksCountMin !== null || categoriesState.filter.booksCountMax !== null ? 'visible' : 'hidden'">
                <mat-icon>close</mat-icon>
              </button>
            </div>

            @if (hasCategoryFilters() || categoriesState.search.name) {
              <button mat-stroked-button (click)="clearAllCategoryFilters()" class="clear-filters-btn"
                      matTooltip="Скинути всі фільтри">
                <mat-icon>filter_alt_off</mat-icon>
                Скинути всі
              </button>
            }
          </div>
        </div>

        <div class="sort-section">
          <span class="sort-label">Сортувати за:</span>
          <div class="sort-options">
            @for (option of categoriesState.sorting.options; track option.field) {
              <div
                class="sort-option"
                [class.active]="isCategorySorted(option)"
                (click)="onCategorySortClick(option)"
                matTooltip="Натисніть для сортування">
                <span class="sort-option-label">{{ option.label }}</span>
                <div class="sort-arrows">
                  @if (getCategorySortDirection(option) === 'asc') {
                    <mat-icon class="sort-arrow active">arrow_upward</mat-icon>
                  } @else if (getCategorySortDirection(option) === 'desc') {
                    <mat-icon class="sort-arrow active">arrow_downward</mat-icon>
                  } @else {
                    <mat-icon class="sort-arrow">arrow_upward</mat-icon>
                  }
                </div>
                @if (isCategorySorted(option)) {
                  <span class="sort-priority">{{ getCategorySortPriority(option) }}</span>
                }
              </div>
            }
            @if (hasCategorySorts()) {
              <button mat-stroked-button (click)="clearCategorySorts()" class="clear-sort-btn"
                      matTooltip="Скинути сортування">
                <mat-icon>clear_all</mat-icon>
                Скинути
              </button>
            }
          </div>
        </div>

        <div class="content-wrapper">
          @if (categoriesState.loading) {
            <div class="loading-overlay">
              <mat-spinner diameter="50"></mat-spinner>
            </div>
          }
          <div class="authors-table-container">
            <table class="authors-table">
              <thead>
              <tr>
                <th>Назва</th>
                <th>Опис</th>
                <th>Кількість книг</th>
                <th>Дії</th>
              </tr>
              </thead>
              <tbody>
                @for (category of categoriesState.items; track category.id) {
                  <tr>
                    <td>{{ category.name }}</td>
                    <td [matTooltip]="category.description || '-'"
                        matTooltipPosition="above">{{ (category.description || '-') | slice:0:50 }}{{ category.description && category.description.length > 50 ? '...' : '' }}
                    </td>
                    <td>{{ getBooksCountText(category.booksCount || 0) }}</td>
                    <td>
                      <div class="action-buttons">
                        <button mat-stroked-button (click)="goToCategoryBooks(category)" class="action-btn">
                          Книги
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <mat-paginator
            [length]="categoriesState.pagination.totalElements"
            [pageSize]="categoriesState.pagination.pageSize"
            [pageIndex]="categoriesState.pagination.currentPage"
            [pageSizeOptions]="[12, 24, 48]"
            (page)="onCategoryPageChange($event)"
            aria-label="Вибрати сторінку">
          </mat-paginator>
        </div>
      </div>
    </mat-tab>

  </mat-tab-group>
</div>

<mat-menu #addBookAction="matMenu">
  <ng-template matMenuContent let-book>
    <button mat-menu-item (click)="addBookToLibrary(book)" [disabled]="isBookInLibrary(book)">
      <mat-icon>add</mat-icon>
      <span>{{ isBookInLibrary(book) ? 'Вже в бібліотеці' : 'Додати до бібліотеки' }}</span>
    </button>
  </ng-template>
</mat-menu>
