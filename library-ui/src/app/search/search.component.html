<div class="search-container">
  <h1 class="page-title">Пошук</h1>

  <mat-tab-group [(selectedIndex)]="uiState.activeTabIndex" (selectedIndexChange)="onTabChange($event)" mat-stretch-tabs="false" mat-align-tabs="start" animationDuration="0ms">

    <mat-tab label="Книги">
      <div class="tab-content">
        <div class="filters-section">
          <div class="filter-row">
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Автор</mat-label>
              <input
                matInput
                [(ngModel)]="filterState.author.searchInput"
                (ngModelChange)="onAuthorSearchInput()"
                (focus)="onAuthorSearchInput()"
                [matAutocomplete]="authorAuto"
                placeholder="Пошук автора...">
              @if (filterState.author.selected) {
                <button mat-icon-button matSuffix (click)="clearAuthorFilter()">
                  <mat-icon>close</mat-icon>
                </button>
              }
              <mat-autocomplete #authorAuto="matAutocomplete" (optionSelected)="onAuthorSelected($event.option.value)">
                @for (author of filterState.author.filtered; track author.id) {
                  <mat-option [value]="author">{{ author.fullName }}</mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>

            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Категорія</mat-label>
              <input
                matInput
                [(ngModel)]="filterState.category.searchInput"
                (ngModelChange)="onCategorySearchInput()"
                (focus)="onCategorySearchInput()"
                [matAutocomplete]="categoryAuto"
                placeholder="Пошук категорії...">
              @if (filterState.category.selected) {
                <button mat-icon-button matSuffix (click)="clearCategoryFilter()">
                  <mat-icon>close</mat-icon>
                </button>
              }
              <mat-autocomplete #categoryAuto="matAutocomplete" (optionSelected)="onCategorySelected($event.option.value)">
                @for (category of filterState.category.filtered; track category.id) {
                  <mat-option [value]="category">{{ category.name }}</mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>

            @if (hasActiveFilters()) {
              <button mat-stroked-button (click)="clearAllFilters()" class="clear-filters-btn" matTooltip="Скинути фільтри">
                <mat-icon>filter_alt_off</mat-icon>
                Скинути фільтри
              </button>
            }
          </div>
        </div>

        <div class="sort-section">
          <span class="sort-label">Сортувати за:</span>
          <div class="sort-options">
            @for (option of booksState.sorting.options; track option.field) {
              <div
                class="sort-option"
                [class.active]="isIncludedInSorting(option)"
                (click)="onSortClick(option)">
                <span class="sort-option-label">{{ option.label }}</span>
                <div class="sort-arrows">
                  @if (getSortDirection(option) === 'asc') {
                    <mat-icon class="sort-arrow active">arrow_upward</mat-icon>
                  } @else if (getSortDirection(option) === 'desc') {
                    <mat-icon class="sort-arrow active">arrow_downward</mat-icon>
                  } @else {
                    <mat-icon class="sort-arrow">arrow_upward</mat-icon>
                  }
                </div>
                @if (isIncludedInSorting(option)) {
                  <span class="sort-priority">{{ getSortPriority(option) }}</span>
                }
              </div>
            }
            @if (hasActiveSorts()) {
              <button mat-stroked-button (click)="clearAllSorts()" class="clear-sort-btn" matTooltip="Скинути сортування">
                <mat-icon>clear_all</mat-icon>
                Скинути
              </button>
            }
          </div>
        </div>

        @if (booksState.loading) {
          <div class="loading-container">
            <mat-spinner diameter="50"></mat-spinner>
          </div>
        } @else {
          <div class="books-grid">
            @for (book of booksState.items; track book.id) {
              <app-book [book]="book"></app-book>
            }
          </div>

          <mat-paginator
            [length]="booksState.pagination.totalElements"
            [pageSize]="booksState.pagination.pageSize"
            [pageIndex]="booksState.pagination.currentPage"
            [pageSizeOptions]="booksState.pagination.pageSizeOptions"
            (page)="onPageChange($event)"
            aria-label="Вибрати сторінку">
          </mat-paginator>
        }
      </div>
    </mat-tab>

    <mat-tab label="Автори">
      <div class="tab-content">
        <div class="author-search-section">
          <mat-form-field appearance="outline" class="author-search-field">
            <mat-label>Пошук за ім'ям</mat-label>
            <input
              matInput
              [(ngModel)]="authorsState.search.name"
              (ngModelChange)="onAuthorNameSearch()"
              placeholder="Введіть ім'я автора...">
            @if (authorsState.search.name) {
              <button mat-icon-button matSuffix (click)="clearAuthorNameSearch()">
                <mat-icon>close</mat-icon>
              </button>
            }
          </mat-form-field>
        </div>

        <div class="sort-section">
          <span class="sort-label">Сортувати за:</span>
          <div class="sort-options">
            @for (option of authorsState.sorting.options; track option.field) {
              <div
                class="sort-option"
                [class.active]="isAuthorSorted(option)"
                (click)="onAuthorSortClick(option)"
                matTooltip="Натисніть для сортування">
                <span class="sort-option-label">{{ option.label }}</span>
                <div class="sort-arrows">
                  @if (getAuthorSortDirection(option) === 'asc') {
                    <mat-icon class="sort-arrow active">arrow_upward</mat-icon>
                  } @else if (getAuthorSortDirection(option) === 'desc') {
                    <mat-icon class="sort-arrow active">arrow_downward</mat-icon>
                  } @else {
                    <mat-icon class="sort-arrow">arrow_upward</mat-icon>
                  }
                </div>
                @if (isAuthorSorted(option)) {
                  <span class="sort-priority">{{ getAuthorSortPriority(option) }}</span>
                }
              </div>
            }
            @if (hasAuthorSorts()) {
              <button mat-stroked-button (click)="clearAuthorSorts()" class="clear-sort-btn" matTooltip="Скинути сортування">
                <mat-icon>clear_all</mat-icon>
                Скинути
              </button>
            }
          </div>
        </div>

        @if (authorsState.loading) {
          <div class="loading-container">
            <mat-spinner diameter="50"></mat-spinner>
          </div>
        } @else {
          <div class="authors-table-container">
            <table class="authors-table">
              <thead>
                <tr>
                  <th>ПІБ</th>
                  <th>Країна</th>
                  <th>Рік народження</th>
                  <th>Рік смерті</th>
                  <th>Кількість книг</th>
                  <th>Дії</th>
                </tr>
              </thead>
              <tbody>
                @for (author of authorsState.items; track author.id) {
                  <tr>
                    <td>
                      <a class="author-link" (click)="goToAuthorDetails(author)">{{ author.fullName }}</a>
                    </td>
                    <td>{{ author.country }}</td>
                    <td>{{ author.birthYear }}</td>
                    <td>{{ author.deathYear || '-' }}</td>
                    <td>{{ getBooksCountText(author.booksCount || 0) }}</td>
                    <td>
                      <div class="action-buttons">
                        <button mat-stroked-button (click)="goToAuthorDetails(author)" class="action-btn">
                          Деталі
                        </button>
                        <button mat-stroked-button (click)="showAuthorBooks(author)" class="action-btn">
                          Книги
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <mat-paginator
            [length]="authorsState.pagination.totalElements"
            [pageSize]="authorsState.pagination.pageSize"
            [pageIndex]="authorsState.pagination.currentPage"
            [pageSizeOptions]="[12, 24, 48]"
            (page)="onAuthorPageChange($event)"
            aria-label="Вибрати сторінку">
          </mat-paginator>
        }
      </div>
    </mat-tab>

    <mat-tab label="Категорії">
      <div class="tab-content placeholder-tab">
        <p>Функція пошуку категорій буде доступна пізніше</p>
      </div>
    </mat-tab>

  </mat-tab-group>
</div>
